/*! For license information please see popup.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(){"use strict";e=function(){return o};var n,o={},r=Object.prototype,i=r.hasOwnProperty,s=Object.defineProperty||function(t,e,n){t[e]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",u=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function d(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{d({},"")}catch(n){d=function(t,e,n){return t[e]=n}}function m(t,e,n,o){var r=e&&e.prototype instanceof w?e:w,i=Object.create(r.prototype),a=new M(o||[]);return s(i,"_invoke",{value:I(t,n,a)}),i}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}o.wrap=m;var g="suspendedStart",f="suspendedYield",y="executing",v="completed",p={};function w(){}function b(){}function E(){}var C={};d(C,c,(function(){return this}));var x=Object.getPrototypeOf,N=x&&x(x(O([])));N&&N!==r&&i.call(N,c)&&(C=N);var S=E.prototype=w.prototype=Object.create(C);function L(t){["next","throw","return"].forEach((function(e){d(t,e,(function(t){return this._invoke(e,t)}))}))}function B(e,n){function o(r,s,a,c){var u=h(e[r],e,s);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==t(d)&&i.call(d,"__await")?n.resolve(d.__await).then((function(t){o("next",t,a,c)}),(function(t){o("throw",t,a,c)})):n.resolve(d).then((function(t){l.value=t,a(l)}),(function(t){return o("throw",t,a,c)}))}c(u.arg)}var r;s(this,"_invoke",{value:function(t,e){function i(){return new n((function(n,r){o(t,e,n,r)}))}return r=r?r.then(i,i):i()}})}function I(t,e,o){var r=g;return function(i,s){if(r===y)throw Error("Generator is already running");if(r===v){if("throw"===i)throw s;return{value:n,done:!0}}for(o.method=i,o.arg=s;;){var a=o.delegate;if(a){var c=k(a,o);if(c){if(c===p)continue;return c}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===g)throw r=v,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=y;var u=h(t,e,o);if("normal"===u.type){if(r=o.done?v:f,u.arg===p)continue;return{value:u.arg,done:o.done}}"throw"===u.type&&(r=v,o.method="throw",o.arg=u.arg)}}}function k(t,e){var o=e.method,r=t.iterator[o];if(r===n)return e.delegate=null,"throw"===o&&t.iterator.return&&(e.method="return",e.arg=n,k(t,e),"throw"===e.method)||"return"!==o&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+o+"' method")),p;var i=h(r,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,p;var s=i.arg;return s?s.done?(e[t.resultName]=s.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=n),e.delegate=null,p):s:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,p)}function T(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function A(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function M(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(T,this),this.reset(!0)}function O(e){if(e||""===e){var o=e[c];if(o)return o.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,s=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=n,t.done=!0,t};return s.next=s}}throw new TypeError(t(e)+" is not iterable")}return b.prototype=E,s(S,"constructor",{value:E,configurable:!0}),s(E,"constructor",{value:b,configurable:!0}),b.displayName=d(E,l,"GeneratorFunction"),o.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===b||"GeneratorFunction"===(e.displayName||e.name))},o.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,E):(t.__proto__=E,d(t,l,"GeneratorFunction")),t.prototype=Object.create(S),t},o.awrap=function(t){return{__await:t}},L(B.prototype),d(B.prototype,u,(function(){return this})),o.AsyncIterator=B,o.async=function(t,e,n,r,i){void 0===i&&(i=Promise);var s=new B(m(t,e,n,r),i);return o.isGeneratorFunction(e)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},L(S),d(S,l,"Generator"),d(S,c,(function(){return this})),d(S,"toString",(function(){return"[object Generator]"})),o.keys=function(t){var e=Object(t),n=[];for(var o in e)n.push(o);return n.reverse(),function t(){for(;n.length;){var o=n.pop();if(o in e)return t.value=o,t.done=!1,t}return t.done=!0,t}},o.values=O,M.prototype={constructor:M,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(A),!t)for(var e in this)"t"===e.charAt(0)&&i.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=n)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function o(o,r){return a.type="throw",a.arg=t,e.next=o,r&&(e.method="next",e.arg=n),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var s=this.tryEntries[r],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=i.call(s,"catchLoc"),u=i.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&i.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var r=o;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var s=r?r.completion:{};return s.type=t,s.arg=e,r?(this.method="next",this.next=r.finallyLoc,p):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),A(n),p}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var o=n.completion;if("throw"===o.type){var r=o.arg;A(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,e,o){return this.delegate={iterator:O(t),resultName:e,nextLoc:o},"next"===this.method&&(this.arg=n),p}},o}function n(t,e,n,o,r,i,s){try{var a=t[i](s),c=a.value}catch(t){return void n(t)}a.done?e(c):Promise.resolve(c).then(o,r)}var o=null,r="",i="",s=!1,a=!0;function c(t,e){var n=document.getElementById("siteBadge"),o=document.getElementById("currentSite");o&&(o.textContent=e||"unknown"),n&&(t?(n.textContent="News Site",n.classList.remove("non-news"),n.classList.add("news")):(n.textContent="Non-News Site",n.classList.remove("news"),n.classList.add("non-news")));var r=document.getElementById("addSiteBtn");r&&(t?(r.textContent="Remove Site",r.classList.remove("add-button"),r.classList.add("remove-button")):(r.textContent="Add as News",r.classList.remove("remove-button"),r.classList.add("add-button")))}function u(){chrome.storage.local.get(["newsSites"],(function(t){var e=document.getElementById("customSitesList"),n=document.getElementById("emptySitesMessage");if(e){e.innerHTML="";var o=t.newsSites||[];o.length>0?(n.style.display="none",e.style.display="block",o.forEach((function(t){var n=document.createElement("li");n.className="site-item";var o=document.createElement("span");o.textContent=t,o.className="site-name";var r=document.createElement("button");r.textContent="Ã—",r.className="site-remove",r.addEventListener("click",(function(){return l(t)})),n.appendChild(o),n.appendChild(r),e.appendChild(n)}))):(n.style.display="block",e.style.display="none")}}))}function l(t){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var n=e[0]?e[0].id:null;chrome.runtime.sendMessage({action:"removeNewsSite",domain:t,tabId:n},(function(e){if(e&&e.success&&(u(),t===r)){s=!1,c(!1,r);var o=document.getElementById("siteBadge");o&&(o.textContent="Non-News Site",o.className="site-badge non-news",o.style.animation="none",setTimeout((function(){o.style.animation="pulse 0.5s"}),10));var i=document.getElementById("addSiteBtn");i&&(i.textContent="Add as News",i.classList.remove("remove-button"),i.classList.add("add-button")),n&&chrome.tabs.sendMessage(n,{action:"siteStatusChanged",isNewsSite:!1,shouldRemoveHighlights:!0},(function(){setTimeout(m,500)}))}}))}))}function d(){s?l(r):r&&chrome.tabs.query({active:!0,currentWindow:!0},(function(t){if(t[0]){var e=t[0].id;chrome.runtime.sendMessage({action:"addNewsSite",domain:r,tabId:e},(function(t){if(t&&t.success){s=!0,c(!0,r),u();var n=document.getElementById("siteBadge");n&&(n.textContent="News Site",n.className="site-badge news-site",n.style.animation="none",setTimeout((function(){n.style.animation="pulse 0.5s"}),10));var o=document.getElementById("addSiteBtn");o&&(o.textContent="Remove Site",o.classList.remove("add-button"),o.classList.add("remove-button")),chrome.tabs.sendMessage(e,{action:"siteStatusChanged",isNewsSite:!0,shouldRemoveHighlights:!1},(function(){setTimeout(m,1e3)}))}}))}}))}function m(){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t[0]&&chrome.tabs.sendMessage(t[0].id,{action:"getStats"},(function(t){t&&!chrome.runtime.lastError&&(document.getElementById("totalAnalyzed").textContent=t.totalAnalyzed||0,document.getElementById("highlightCount").textContent=t.highlightCount||0,document.getElementById("fakeNewsCount").textContent=t.fakeNewsCount||0,document.getElementById("clickbaitCount").textContent=t.clickbaitOnlyCount||0,document.getElementById("bothCount").textContent=t.bothCount||0,t.isNewsSite!==s&&c(s=t.isNewsSite,r))}))}))}document.addEventListener("DOMContentLoaded",(function(){var t=document.getElementById("highlightToggle"),c=document.getElementById("analysisToggle"),u=document.getElementById("currentSite"),l=document.getElementById("siteBadge"),d=document.getElementById("totalAnalyzed"),m=document.getElementById("highlightCount"),h=document.getElementById("addSiteBtn"),g=document.getElementById("customSitesList"),f=document.getElementById("emptySitesMessage");function y(){var h;return h=e().mark((function n(){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){chrome.storage.local.get(["highlightingEnabled","analysisEnabled"],(function(n){var o=!1!==n.highlightingEnabled,r=!1!==n.analysisEnabled;t.checked=o,c.checked=r,t.disabled=!r,e()}))}));case 2:return e.next=4,new Promise((function(t){var e=setTimeout((function(){console.error("Timed out while getting tab info"),u.textContent="Timeout Error",l.textContent="Unknown",l.className="site-badge non-news",t()}),5e3);chrome.tabs.query({active:!0,currentWindow:!0},(function(n){if(clearTimeout(e),console.log("Got tabs response:",n),!n||0===n.length)return u.textContent="Unknown site",l.textContent="Unknown",a=!1,void t();var c=n[0];if(o=c.id,!p(c.url))return u.textContent="System page",l.textContent="Not applicable",l.classList.add("non-news"),a=!1,d.textContent="N/A",m.textContent="N/A",document.getElementById("fakeNewsCount").textContent="N/A",document.getElementById("clickbaitCount").textContent="N/A",document.getElementById("bothCount").textContent="N/A",void t();try{var h=new URL(c.url);if(r=h.hostname,console.log("Current domain:",r),u.textContent=r||"Unknown site",i=w(r),console.log("Extracted domain: ".concat(i," from ").concat(r)),setTimeout((function(){"Loading..."===l.textContent&&(console.log("Emergency fallback: Updating badge"),l.textContent="Status Unknown",l.className="site-badge non-news")}),2e3),"bbc"===i||r.includes("bbc.co")||r.includes("bbc.com")||"foxnews"===i||r.includes("foxnews.com"))return console.log("Hardcoded news site detected in popup: "+i),s=!0,l.textContent="News Site",l.className="site-badge news",v(),void t();chrome.storage.sync.get(["customNewsSites"],(function(e){if(console.log("Got custom sites:",e),(e.customNewsSites||[]).includes(i))s=!0,l.textContent="News Site",l.className="site-badge news",v(),t();else{console.log("Sending checkNewsSite message to background script");var n=setTimeout((function(){console.error("Background script did not respond in time"),l.textContent="Timeout Error",l.className="site-badge non-news",v(),t()}),3e3);try{chrome.runtime.sendMessage({action:"checkNewsSite",domain:i},(function(e){if(clearTimeout(n),console.log("Got response from background:",e),!e)return console.error("No response from background script"),l.textContent="Error",l.className="site-badge non-news",v(),void t();e.isNewsSite?(s=!0,l.textContent="News Site",l.className="site-badge news"):(s=!1,l.textContent="Non-News Site",l.className="site-badge non-news"),v(),t()}))}catch(e){clearTimeout(n),console.error("Error sending message to background script:",e),l.textContent="Error",l.className="site-badge non-news",v(),t()}}}))}catch(e){console.error("Error processing tab URL:",e),u.textContent="Error: "+e.message,l.textContent="Error",l.className="site-badge non-news",a=!1,t()}}))}));case 4:b(),a&&o&&N(o);case 6:case"end":return e.stop()}}),n)})),y=function(){var t=this,e=arguments;return new Promise((function(o,r){var i=h.apply(t,e);function s(t){n(i,o,r,s,a,"next",t)}function a(t){n(i,o,r,s,a,"throw",t)}s(void 0)}))},y.apply(this,arguments)}function v(){s?(h.textContent="Remove Site",h.classList.remove("add-button"),h.classList.add("remove-button")):(h.textContent="Add as News",h.classList.remove("remove-button"),h.classList.add("add-button"))}function p(t){return t&&!t.startsWith("chrome://")&&!t.startsWith("chrome-extension://")&&!t.startsWith("chrome-search://")&&!t.startsWith("about:")&&!t.startsWith("edge://")&&!t.startsWith("brave://")&&!t.startsWith("devtools://")}function w(t){if(!t)return"";var e=t;e.startsWith("www.")&&(e=e.slice(4));var n=e.split(".");return n.length>2&&["co","com","net","org","ac","edu","gov"].includes(n[n.length-2])?n[n.length-3]:n.length>=2?n[0]:e}function b(){chrome.storage.sync.get(["customNewsSites"],(function(t){var e=t.customNewsSites||[];e.length>0?(f.style.display="none",g.innerHTML="",e.forEach((function(t){var e=document.createElement("li");e.className="site-item",e.innerHTML="\n                        <span>".concat(t,'</span>\n                        <button class="delete-site" data-site="').concat(t,'">&times;</button>\n                    '),g.appendChild(e)})),document.querySelectorAll(".delete-site").forEach((function(t){t.addEventListener("click",(function(){E(this.getAttribute("data-site"))}))}))):(f.style.display="block",g.innerHTML="")}))}function E(t){chrome.storage.sync.get(["customNewsSites"],(function(e){var n=e.customNewsSites||[];n=n.filter((function(e){return e!==t})),chrome.storage.sync.set({customNewsSites:n},(function(){b(),x("Removed ".concat(t," from news sites"),"success"),t===i&&(l.textContent="Non-News Site",l.classList.remove("news"),l.classList.add("non-news")),C(t,!1)}))}))}function C(t,e){chrome.tabs.query({},(function(n){n.forEach((function(n){if(p(n.url))try{w(new URL(n.url).hostname)===t&&(console.log("Notifying tab ".concat(n.id," that site status changed to ").concat(e?"news":"non-news")),chrome.tabs.sendMessage(n.id,{action:"siteStatusChanged",isNewsSite:e,shouldRemoveHighlights:!e,forceAnalysis:e},(function(t){chrome.runtime.lastError?console.log("Error sending status update to tab:",chrome.runtime.lastError.message):t&&t.success&&console.log("Tab successfully updated")})))}catch(t){console.log("Error processing tab URL:",t)}}))}))}function x(t,e){var n=document.querySelector(".message");n&&n.remove();var o=document.createElement("div");o.className="message ".concat(e),o.textContent=t;var r=document.querySelector(".custom-sites");r.parentNode.insertBefore(o,r.nextSibling),setTimeout((function(){o.classList.add("fade")}),2e3)}function N(t){document.getElementById("totalAnalyzed").textContent="0",document.getElementById("highlightCount").textContent="0",document.getElementById("fakeNewsCount").textContent="0",document.getElementById("clickbaitCount").textContent="0",document.getElementById("bothCount").textContent="0",chrome.tabs.sendMessage(t,{action:"getStats"},(function(e){if(chrome.runtime.lastError)console.error("Error getting stats:",chrome.runtime.lastError);else if(e){if(e.siteStatusPending){var n=document.getElementById("siteBadge");return n&&(n.textContent="Determining...",n.className="site-badge pending"),void setTimeout((function(){return N(t)}),1e3)}if(e.analysisInProgress){console.log("Analysis in progress, will check again soon");var o=document.getElementById("siteBadge");return o&&!e.siteStatusPending&&(o.textContent=e.isNewsSite?"News Site":"Non-News Site",o.className="site-badge "+(e.isNewsSite?"news":"non-news")),void setTimeout((function(){return N(t)}),1e3)}document.getElementById("totalAnalyzed").textContent=e.totalAnalyzed||0,document.getElementById("highlightCount").textContent=e.highlightCount||0,document.getElementById("fakeNewsCount").textContent=e.fakeNewsCount||0,document.getElementById("clickbaitCount").textContent=e.clickbaitOnlyCount||0,document.getElementById("bothCount").textContent=e.bothCount||0,document.getElementById("totalAnalyzed").classList.add("count-animation"),document.getElementById("highlightCount").classList.add("count-animation"),document.getElementById("fakeNewsCount").classList.add("count-animation"),document.getElementById("clickbaitCount").classList.add("count-animation"),document.getElementById("bothCount").classList.add("count-animation");var r=document.getElementById("siteBadge");r&&(r.textContent=e.isNewsSite?"News Site":"Non-News Site",r.className="site-badge "+(e.isNewsSite?"news":"non-news"),s=e.isNewsSite,v()),console.log("Statistics updated:",e)}}))}u.textContent="Loading...",l.textContent="Loading...",d.textContent="...",m.textContent="...",document.getElementById("fakeNewsCount").textContent="...",document.getElementById("clickbaitCount").textContent="...",document.getElementById("bothCount").textContent="...",function(){y.apply(this,arguments)}(),t.addEventListener("change",(function(){var e=t.checked;chrome.storage.local.set({highlightingEnabled:e}),a&&chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t.length>0&&p(t[0].url)&&chrome.tabs.sendMessage(t[0].id,{highlightingEnabled:e},(function(t){chrome.runtime.lastError&&console.log("Error sending message:",chrome.runtime.lastError.message)}))}));var n=document.createElement("span");n.classList.add("toggle-ripple"),document.querySelector(".toggle").appendChild(n),setTimeout((function(){return n.remove()}),500)})),c.addEventListener("change",(function(){var e=c.checked;chrome.storage.local.set({analysisEnabled:e}),t.disabled=!e,!e&&t.checked&&(t.checked=!1,chrome.storage.local.set({highlightingEnabled:!1})),a&&chrome.tabs.query({active:!0,currentWindow:!0},(function(n){n.length>0&&p(n[0].url)&&chrome.tabs.sendMessage(n[0].id,{analysisEnabled:e,highlightingEnabled:!!e&&t.checked},(function(t){chrome.runtime.lastError&&console.log("Error sending message:",chrome.runtime.lastError.message)}))}));var n=document.createElement("span");n.classList.add("toggle-ripple"),c.parentElement.appendChild(n),setTimeout((function(){return n.remove()}),500)})),h.addEventListener("click",(function(){s?E(i):(i&&chrome.storage.sync.get(["customNewsSites"],(function(t){var e=t.customNewsSites||[];e.includes(i)?x("This site is already in your list","error"):(e.push(i),chrome.storage.sync.set({customNewsSites:e},(function(){b(),x("Added ".concat(i," to news sites"),"success"),l.textContent="News Site",l.classList.remove("non-news"),l.classList.add("news"),C(i,!0)})))})),a&&o&&(console.log("Requesting immediate analysis after adding news site"),chrome.tabs.sendMessage(o,{action:"siteStatusChanged",isNewsSite:!0,shouldRemoveHighlights:!1,forceAnalysis:!0},(function(t){setTimeout((function(){N(o)}),1500)}))))})),b(),document.getElementById("runTests").addEventListener("click",(function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){chrome.tabs.executeScript(t[0].id,{code:'console.log("Running AI model tests from popup"); if(window.runAIModelTests) { window.runAIModelTests(); }'})}))})),document.getElementById("refreshStats").addEventListener("click",(function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t.length>0&&p(t[0].url)&&N(t[0].id)}))}))})),document.addEventListener("DOMContentLoaded",(function(){chrome.runtime.sendMessage({action:"getCurrentTabInfo"},(function(t){t&&!t.error&&(o=t.tabId,r=t.domain,c(s=t.isNewsSite,r))})),chrome.storage.local.get(["highlightingEnabled"],(function(t){var e=document.getElementById("highlightToggle");e&&(e.checked=!1!==t.highlightingEnabled)})),u(),m(),document.getElementById("addSiteBtn").addEventListener("click",d),document.getElementById("highlightToggle").addEventListener("change",(function(t){var e=t.target.checked;chrome.storage.local.set({highlightingEnabled:e}),chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t[0]&&chrome.tabs.sendMessage(t[0].id,{highlightingEnabled:e})}))})),document.getElementById("refreshStats").addEventListener("click",m)}))})();